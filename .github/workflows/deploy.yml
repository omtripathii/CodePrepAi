name: ğŸš€ Refresh Backend Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allows manual triggering

jobs:
  refresh:
    runs-on: ubuntu-latest
    name: ğŸ”„ Refresh EC2 Backend
    
    steps:
      - name: ğŸ­ ASCII Art Banner
        run: |
          echo "
          â•­â”â”â”â•®â•±â•±â•±â•±â•±â•±â•­â•®â•±â•±â•±â•±â•±â•±â•±â•±â•­â”â”â”â•®â•±â•±â•±â•±â•±â•±â•­â•®
          â”ƒâ•­â”â•®â”ƒâ•±â•±â•±â•±â•±â•±â”ƒâ”ƒâ•±â•±â•±â•±â•±â•±â•±â•±â”ƒâ•­â”â•®â”ƒâ•±â•±â•±â•±â•±â•±â”ƒâ”ƒ
          â”ƒâ”ƒâ•±â•°â•‹â”â”â”³â”â”â•®â”ƒâ”ƒâ•±â•±â•­â”â”â”³â”â•®â”ƒâ•°â”â”â”³â”â”â”³â”â”â”ƒâ”ƒ
          â”ƒâ”ƒâ•±â•­â”«â•­â•®â”ƒâ•­â•®â”ƒâ”ƒâ”ƒâ•±â•­â”«â•­â•®â”ƒâ•­â•¯â•°â”â”â•®â”ƒâ•­â•®â”ƒâ•­â•®â”ƒâ”ƒ
          â”ƒâ•°â”â•¯â”ƒâ•­â•®â”ƒâ•°â•¯â”ƒâ”ƒâ•°â”â•¯â”ƒâ•°â•¯â”ƒâ”ƒâ•±â”ƒâ•°â”â•¯â”ƒâ•°â•¯â”ƒâ•°â•¯â”ƒâ•°â•®
          â•°â”â”â”â”»â•¯â•°â”»â”â”â•¯â•°â”â”â”â”»â”â”â”»â•¯â•±â•°â”â”â”â”»â”â”â”»â”â”â”»â”â•¯
          " 

      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2.key
          chmod 600 ~/.ssh/ec2.key
          echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

      - name: ğŸ”„ Update Repository and Restart Services
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "ğŸŒŸ Connecting to server..."
          ssh -i ~/.ssh/ec2.key $EC2_USERNAME@$EC2_HOST "
            echo 'ğŸ‰ Connection successful!'
            
            echo 'ğŸ“‚ Navigating to CodePrepAi directory...'
            cd CodePrepAi
            
            echo 'â¬‡ï¸ Pulling latest changes from GitHub...'
            git pull
            
            echo 'ğŸ“¦ Installing any new dependencies...'
            cd server
            npm install --no-fund --no-audit
            
            echo 'ğŸ”„ Restarting PM2 process...'
            pm2 restart backend
            
            echo 'ğŸ’¾ Saving PM2 process list...'
            pm2 save
            
            echo 'ğŸ”„ Restarting Nginx...'
            sudo systemctl restart nginx
            
            echo 'âœ… Deployment refresh completed successfully!'
            
            echo '
            â•­â”â”â”â”â•®â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•­â•®â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•­â•®
            â”ƒâ•­â•®â•­â•®â”ƒâ•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â”ƒâ”ƒâ•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±â”ƒâ”ƒ
            â•°â•¯â”ƒâ”ƒâ•°â”»â”â”³â”â”â”³â”â•®â•­â”â”â”³â•®â•­â”³â”â•¯â”£â”â”â”³â”â”³â”â”â”³â”â”â”³â”â”â”«â”ƒ
            â•±â•±â”ƒâ”ƒâ•­â”â”«â•­â•®â”ƒâ•­â•®â”«â•­â•®â”ƒâ•°â•¯â”ƒâ•­â•®â”ƒâ”ƒâ”â”«â•­â”«â•­â•®â”ƒâ•­â•®â”ƒâ”ƒâ”â”«â”ƒ
            â•±â•±â”ƒâ”ƒâ”ƒâ”â”«â•­â•®â”ƒâ”ƒâ”ƒâ”ƒâ•­â•®â”ƒâ”ƒâ”ƒâ”ƒâ•°â•¯â”ƒâ”ƒâ”â”«â”ƒâ”ƒâ•°â•¯â”ƒâ•°â•¯â”ƒâ”ƒâ”â”«â•°â•®
            â•±â•±â•°â•¯â•°â”â”»â•¯â•°â”»â•¯â•°â”»â•¯â•°â”»â”»â”»â”»â”â”â”»â”â”â”»â•¯â•°â”â”â”»â”â”â”»â”â”â”»â”â•¯
            '
          "

      - name: ğŸŠ Post-Refresh Message
        run: |
          echo "
          â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
          â”ƒ  ğŸ‰ Refresh completed successfully! ğŸ‰  â”ƒ
          â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
          "